name: Auto Convert List to MRS
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Mihomo
        run: |
          wget -O mihomo.gz https://github.com/MetaCubeX/mihomo/releases/download/v1.18.9/mihomo-linux-amd64-v1.18.9.gz
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Python Script Conversion
        shell: python
        run: |
          import os
          import subprocess

          # 查找所有 .list 文件
          list_files = []
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file.endswith(".list"):
                      list_files.append(os.path.join(root, file))

          for input_file in list_files:
              output_file = input_file.replace(".list", ".mrs")
              print(f"Converting: {input_file} -> {output_file}")
              
              with open(input_file, 'r') as f:
                  lines = f.readlines()
              
              # 自动补全 DOMAIN, 前缀
              processed_rules = []
              for line in lines:
                  line = line.strip()
                  if line and not line.startswith('#'):
                      if ',' not in line:
                          processed_rules.append(f"DOMAIN,{line}")
                      else:
                          processed_rules.append(line)
              
              payload = "\n".join(processed_rules)
              
              # 核心修改：使用简化的 subprocess 调用，彻底规避 config.yaml 需求
              try:
                  # 使用 rule-set compile 直接读取处理后的内容
                  with open("temp.list", "w") as tmp:
                      tmp.write(payload)
                  
                  # 运行 compile 命令，不加载任何配置
                  subprocess.run(['./mihomo', 'rule-set', 'compile', 'temp.list', output_file], timeout=5)
                  print(f"Successfully generated {output_file}")
              except Exception as e:
                  print(f"Failed to convert {input_file}: {e}")

      - name: Push back
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: 强制生成 MRS 文件"
            git push
          fi
