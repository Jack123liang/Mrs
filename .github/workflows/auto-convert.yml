name: Auto Convert List to MRS
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Convert with Docker Entrypoint Override
        run: |
          # 遍历所有 .list 文件
          find . -name "*.list" -type f | while read -r file; do
            echo "Processing $file"
            
            # 1. 预处理格式：确保每一行都有前缀，这是 compile 成功的关键
            sed -E '/^[^,]+$/s/(.*)/DOMAIN,\1/' "$file" > temp.list
            
            # 2. 覆盖 Entrypoint 强制只运行 compile 命令
            # --entrypoint "" 允许我们直接运行容器内的路径
            # /mihomo 是容器内程序的标准路径
            docker run --rm \
              -v $(pwd):/work -w /work \
              --entrypoint "/mihomo" \
              metacubex/mihomo \
              rule-set compile temp.list "${file%.list}.mrs"
              
            echo "Finished $file"
            rm temp.list
          done

      - name: Push back
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes detected"
          else
            git commit -m "chore: 最终 Docker 强制转换成功"
            git push
          fi

