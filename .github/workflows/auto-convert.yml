name: Auto Convert List to MRS

on:
  push:
    branches:
      - main
    paths:
      - 'rules/domain/*.list'  # 只有当 list 文件变动时才触发
  workflow_dispatch:          # 允许你手动点击运行

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write         # 授予脚本推送文件回到仓库的权限

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Mihomo
        run: |
          # 获取最新的 Mihomo 内核
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/v1.18.9 | grep "browser_download_url.*mihomo-linux-amd64-v1.18.9.gz" | cut -d '"' -f 4)
          curl -L -o mihomo.gz "$MIHOMO_URL"
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Convert all lists
        run: |
          # 遍历 rules/domain 目录下所有 .list 文件
          for file in rules/domain/*.list; do
            # 获取不带后缀的文件名
            filename=$(basename "$file" .list)
            echo "正在转换: $filename"
            # 执行转换命令
            ./mihomo rule-set compile "$file" "rules/domain/${filename}.mrs"
          done

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查是否有文件更新
          if [ -n "$(git status --porcelain)" ]; then
            git add rules/domain/*.mrs
            git commit -m "Auto-sync: Update MRS binary rulesets"
            git push
          else
            echo "没有发现变化，跳过提交。"
          fi
